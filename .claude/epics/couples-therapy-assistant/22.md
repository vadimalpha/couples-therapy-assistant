---
name: chat-infrastructure
status: closed
created: 2025-12-25T17:01:17Z
updated: 2025-12-25T17:41:54Z
github: https://github.com/vadimalpha/taskmanager/issues/22
---

# Task: Chat Infrastructure

## Description

Build the foundational chat infrastructure that will be reused across all conversational features: intake interview, exploration chat, guidance chat, and shared relationship chat. This includes WebSocket server setup, React chat components, message streaming, and conversation session management.

## Acceptance Criteria

- [ ] WebSocket server setup (Socket.IO or native WS)
- [ ] ChatWindow component (main container with message list + input)
- [ ] ChatMessage component (individual bubble, role-aware styling: user/AI/partner)
- [ ] ChatInput component (text input with send button, typing indicator support)
- [ ] StreamingMessage component (AI response with real-time text streaming via SSE)
- [ ] ChatHeader component (title, status, participant indicators)
- [ ] Conversation session management (create, get, finalize, lock)
- [ ] Message persistence to SurrealDB
- [ ] useConversation React hook for chat state management
- [ ] Reconnection logic with exponential backoff

## Technical Details

**Frontend Components** (`src/components/chat/`):
```
ChatWindow.tsx      - Main chat container
ChatMessage.tsx     - Individual message bubble (user/AI/partner-a/partner-b variants)
ChatInput.tsx       - Text input + send button
StreamingMessage.tsx - AI message with streaming text
ChatHeader.tsx      - Title, status, participants
TypingIndicator.tsx - Shows when AI is generating
```

**useConversation Hook**:
```typescript
const { messages, sendMessage, isStreaming, finalize, isFinalized } = useConversation(sessionId);
```

**Backend WebSocket Handlers** (`src/websocket/`):
- `connection` - Authenticate and join conversation room
- `message` - Send user message, trigger AI response
- `typing` - Broadcast typing status
- `disconnect` - Cleanup and save state

**Streaming Implementation**:
- Use Server-Sent Events (SSE) for AI response streaming
- WebSocket for real-time message delivery and presence
- Optimistic UI updates for sent messages

**Conversation Session Table**:
```typescript
interface ConversationSession {
  id: string;
  conflict_id?: string;  // null for intake
  user_id: string;
  session_type: 'intake' | 'individual_a' | 'individual_b' | 'joint_context_a' | 'joint_context_b' | 'relationship_shared';
  status: 'active' | 'finalized';
  messages: ConversationMessage[];
  created_at: Date;
  finalized_at?: Date;
}
```

**API Endpoints**:
- `POST /api/conversations` - Create new session
- `GET /api/conversations/:id` - Get session with messages
- `POST /api/conversations/:id/messages` - Add message (triggers AI response)
- `POST /api/conversations/:id/finalize` - Lock session
- WebSocket: `/ws/conversations/:id` - Real-time updates

**Error Handling**:
- Queue messages during WebSocket disconnection
- Sync on reconnect
- Graceful degradation to polling if WebSocket fails

## Dependencies

- [ ] Task #13 complete (Database & Auth - SurrealDB schema)
- [ ] Redis setup (for WebSocket pub/sub if scaling)

## Effort Estimate

- **Size**: L
- **Hours**: 48-64 hours (6-8 days)
- **Parallel**: false (foundation for all chat features)

## Definition of Done

- [ ] WebSocket server handles connections, messages, disconnections
- [ ] All chat components render correctly (user/AI/partner messages)
- [ ] AI responses stream in real-time (SSE)
- [ ] Messages persist to SurrealDB
- [ ] Conversation finalization locks the session
- [ ] Reconnection works with exponential backoff
- [ ] useConversation hook manages all chat state
- [ ] Unit tests for WebSocket handlers
- [ ] Integration tests for message flow
- [ ] Mobile-responsive chat UI
- [ ] Typing indicators work
