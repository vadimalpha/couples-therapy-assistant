---
name: shared-relationship-chat
status: closed
created: 2025-12-25T17:01:17Z
updated: 2025-12-25T18:43:47Z
github: https://github.com/vadimalpha/taskmanager/issues/23
---

# Task: Shared Relationship Chat

## Description

Implement the shared relationship chat where both partners can chat together with the AI therapist. This unlocks after both partners receive their joint-context guidance. The AI facilitates a joint conversation, addressing both partners, suggesting dialogue exercises, and helping them find shared understanding.

## Acceptance Criteria

- [ ] SharedRelationshipChat component (both partners in same chat)
- [ ] Multi-user WebSocket room for shared conversation
- [ ] Relationship synthesis (initial AI message with all context)
- [ ] Both partners can send messages, AI addresses the couple
- [ ] sender_id tracked for each message (AI knows who sent what)
- [ ] Typing indicators for multi-user coordination
- [ ] Participant badges showing who's online
- [ ] AI uses relationship chat system prompt (neutral facilitator)

## Technical Details

**Frontend Components**:
- `SharedRelationshipChat.tsx` - Shared chat page
- `ParticipantBadge.tsx` - Shows partner names and online status
- Reuses ChatWindow, ChatMessage, ChatInput from Chat Infrastructure
- ChatMessage supports `partner-a` and `partner-b` styling variants

**Conversation Session Type**:
- `relationship_shared` - Both partners participate

**Multi-User WebSocket Room**:
- Both partners join same room: `/ws/conversations/:id`
- Messages broadcast to all room participants
- Typing status shows which partner is typing
- Presence tracking (online/offline indicators)

**Relationship Synthesis** (`relationship-synthesis.txt`):
- Context: Both exploration transcripts + all previous guidance
- Output: Initial message addressing the couple
- Highlights shared needs, alignment points, divergence points
- Suggests dialogue framework

**Relationship Chat Prompt** (`relationship-chat.txt`):
- Addresses them as a couple, not individuals
- When message comes in, notes sender_id to know who sent it
- Responds to both partners, not just the one who messaged
- Facilitates dialogue, de-escalation, shared understanding

**API Endpoint Modifications**:
- `POST /api/conversations/:id/messages` - Include sender_id
- `GET /api/conversations/:id` - Return messages with sender info
- Verify both partners have access to shared session

**Unlock Logic**:
- Shared chat unlocks when:
  1. Both partners have finalized exploration
  2. Both have received joint-context guidance
- Button: "Join Shared Conversation" appears in GuidanceChat

## Dependencies

- [ ] Task #13 complete (Database & Auth)
- [ ] Chat Infrastructure complete
- [ ] Guidance Synthesis complete (joint-context guidance exists)

## Effort Estimate

- **Size**: M
- **Hours**: 32-40 hours (4-5 days)
- **Parallel**: false (depends on Guidance Synthesis)

## Definition of Done

- [ ] Both partners can join shared chat
- [ ] AI facilitates conversation, addresses couple
- [ ] Messages show which partner sent them
- [ ] Typing indicators work for multi-user
- [ ] Participant badges show online status
- [ ] Relationship synthesis generates good initial message
- [ ] WebSocket handles multi-user room correctly
- [ ] Unit tests for multi-user WebSocket
- [ ] E2E test: Both partners in shared chat
- [ ] Mobile-responsive shared chat UI
