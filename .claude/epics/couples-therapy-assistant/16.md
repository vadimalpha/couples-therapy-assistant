---
name: Guidance Synthesis & Refinement
status: closed
created: 2025-12-23T20:56:49Z
updated: 2025-12-25T18:05:15Z
github: https://github.com/vadimalpha/taskmanager/issues/16
depends_on: [13, 22, 15]
parallel: false
conflicts_with: []
---

# Task: Guidance Synthesis & Refinement

## Description

Implement the guidance synthesis pipeline that generates personalized AI guidance after both partners finalize their exploration conversations. This includes individual guidance (from each partner's conversation), joint-context guidance (incorporating both perspectives), and the ability to continue chatting to refine guidance.

## Acceptance Criteria

- [ ] Background job triggers after partner finalizes exploration
- [ ] Guidance 1A: Synthesize Partner A's exploration → individual guidance (chat message)
- [ ] Guidance 1B: Synthesize Partner B's exploration → individual guidance (chat message)
- [ ] After BOTH finalize, generate joint-context guidance:
  - Guidance 2A: Both conversations → personalized guidance for Partner A
  - Guidance 2B: Both conversations → personalized guidance for Partner B
- [ ] All guidance delivered as chat messages that can be refined
- [ ] GuidanceChat component for interactive refinement
- [ ] BullMQ job queue for synthesis (async processing)

## Technical Details

**Guidance Synthesis Service** (`src/services/guidance-synthesis.ts`):
```typescript
synthesizeIndividualGuidance(sessionId: string): Promise<void>
synthesizeJointContextGuidance(conflictId: string, partnerId: string): Promise<void>
```

**Conversation Session Types for Guidance**:
- `joint_context_a` - Partner A's guidance refinement session
- `joint_context_b` - Partner B's guidance refinement session

**Background Job Flow**:
1. Partner A finalizes → trigger `synthesizeIndividualGuidance(individual_a)`
2. Partner B finalizes → trigger `synthesizeIndividualGuidance(individual_b)`
3. Both finalized → trigger:
   - `synthesizeJointContextGuidance(conflict, partner_a)`
   - `synthesizeJointContextGuidance(conflict, partner_b)`

**Prompt Templates**:
- `joint-context-synthesis.txt` - Transform transcripts to personalized guidance
- `joint-context-chat.txt` - Ongoing refinement after initial guidance

**Synthesis Context Window**:
- Individual: Full exploration transcript + intake data (~5,000-8,000 tokens)
- Joint: Both transcripts + intake data + previous guidance (~12,000-20,000 tokens)

**Guidance Output Format**:
- Delivered as chat message (not JSON cards)
- Natural, conversational tone
- Invites continued dialogue ("Does this resonate? What questions do you have?")

**Frontend Components**:
- `GuidanceChat.tsx` - Chat interface for guidance refinement
- Reuses ChatWindow, ChatMessage, ChatInput from Chat Infrastructure

## Dependencies

- [ ] Task #13 complete (Database & Auth)
- [ ] Task #22 complete (Chat Infrastructure)
- [ ] Task #15 complete (Exploration Chat Flow - exploration transcripts exist)
- [ ] Redis + BullMQ setup for job queue

## Effort Estimate

- **Size**: L
- **Hours**: 48-56 hours (6-7 days)
- **Parallel**: false (depends on Exploration Chat Flow)

## Definition of Done

- [ ] Individual guidance synthesized after each partner finalizes
- [ ] Joint-context guidance generated after both finalize
- [ ] Guidance delivered as interactive chat messages
- [ ] Partners can continue chatting to refine guidance
- [ ] BullMQ handles async synthesis jobs
- [ ] Proper error handling if synthesis fails
- [ ] Token usage tracked for cost monitoring
- [ ] Unit tests for synthesis service
- [ ] E2E test: Full guidance flow from exploration to refinement
