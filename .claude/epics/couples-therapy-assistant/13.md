---
name: Database & Firebase Auth Foundation
status: closed
created: 2025-12-23T20:56:49Z
updated: 2025-12-25T17:25:00Z
github: https://github.com/vadimalpha/taskmanager/issues/13
depends_on: [21]
parallel: false
conflicts_with: []
---

# Task: Database & Firebase Auth Foundation (BOR Pattern)

## Description

Set up the foundational database schema in SurrealDB and implement Firebase Authentication following the BOR project pattern. This includes Firebase project setup, frontend AuthSystem class, backend token verification middleware, and the relationship invitation/pairing system.

## Acceptance Criteria

- [ ] Firebase project configured with Email/Password + Google Sign-In enabled
- [ ] Frontend AuthSystem class (BOR pattern) with signIn, signUp, signInWithGoogle, signOut
- [ ] Backend Firebase Admin SDK middleware verifies tokens on protected routes
- [ ] SurrealDB schema created with tables: users, relationships, conflicts, conversation_sessions, conversation_messages
- [ ] User sync service (Firebase -> SurrealDB on first login)
- [ ] Relationship invitation system (`POST /api/relationships/invite`) generates unique tokens
- [ ] Relationship acceptance endpoint (`POST /api/relationships/accept/:token`) pairs users
- [ ] Users can only access their own data (authorization checks)

## Technical Details

**Firebase Configuration (Frontend)**:
```javascript
const firebaseConfig = {
  apiKey: "AIzaSyBd5c4oZXZm6jy-OWUQVZoOhowNdYGU2y4",
  authDomain: "weiu-fbfe2.firebaseapp.com",
  projectId: "weiu-fbfe2",
  storageBucket: "weiu-fbfe2.firebasestorage.app",
  messagingSenderId: "87341697110",
  appId: "1:87341697110:web:04888ed6167bfbe531d3f7",
  measurementId: "G-8H2NZZ3KH4"
};
```

**SurrealDB Cloud Connection**:
```
URL: wss://mystic-jungle-06dlcjsj2pp651hvfm553m8i70.aws-euw1.surreal.cloud
Username: admin
Password: rY&c2U14Bj0@S6Rk
Namespace: couples_therapy
Database: main
```

**Database Schema (SurrealDB)**:
```surrealql
-- Users table (synced from Firebase)
DEFINE TABLE users SCHEMAFULL;
DEFINE FIELD firebase_uid ON users TYPE string;
DEFINE FIELD email ON users TYPE string ASSERT string::is::email($value);
DEFINE FIELD display_name ON users TYPE option<string>;
DEFINE FIELD intake_completed ON users TYPE bool DEFAULT false;
DEFINE FIELD intake_data ON users TYPE option<object>;
DEFINE FIELD created_at ON users TYPE datetime DEFAULT time::now();
DEFINE INDEX firebase_uid_idx ON users FIELDS firebase_uid UNIQUE;
DEFINE INDEX email_idx ON users FIELDS email UNIQUE;

-- Relationships table
DEFINE TABLE relationships SCHEMAFULL;
DEFINE FIELD partner_a_id ON relationships TYPE record<users>;
DEFINE FIELD partner_b_id ON relationships TYPE option<record<users>>;
DEFINE FIELD status ON relationships TYPE string ASSERT $value IN ['pending', 'active', 'unpaired'];
DEFINE FIELD invitation_token ON relationships TYPE option<string>;
DEFINE FIELD invitation_email ON relationships TYPE option<string>;
DEFINE FIELD created_at ON relationships TYPE datetime DEFAULT time::now();
DEFINE FIELD confirmed_at ON relationships TYPE option<datetime>;

-- Conflicts table (for conversational model)
DEFINE TABLE conflicts SCHEMAFULL;
DEFINE FIELD relationship_id ON conflicts TYPE record<relationships>;
DEFINE FIELD created_by ON conflicts TYPE record<users>;
DEFINE FIELD title ON conflicts TYPE string;
DEFINE FIELD status ON conflicts TYPE string ASSERT $value IN ['exploring', 'synthesizing', 'guidance', 'shared', 'archived'];
DEFINE FIELD privacy_setting ON conflicts TYPE string ASSERT $value IN ['private', 'shared'];
DEFINE FIELD created_at ON conflicts TYPE datetime DEFAULT time::now();

-- Conversation sessions table
DEFINE TABLE conversation_sessions SCHEMAFULL;
DEFINE FIELD conflict_id ON conversation_sessions TYPE record<conflicts>;
DEFINE FIELD user_id ON conversation_sessions TYPE record<users>;
DEFINE FIELD session_type ON conversation_sessions TYPE string ASSERT $value IN ['individual_a', 'individual_b', 'joint_context_a', 'joint_context_b', 'relationship_shared'];
DEFINE FIELD status ON conversation_sessions TYPE string ASSERT $value IN ['active', 'finalized'];
DEFINE FIELD created_at ON conversation_sessions TYPE datetime DEFAULT time::now();
DEFINE FIELD finalized_at ON conversation_sessions TYPE option<datetime>;

-- Conversation messages table
DEFINE TABLE conversation_messages SCHEMAFULL;
DEFINE FIELD session_id ON conversation_messages TYPE record<conversation_sessions>;
DEFINE FIELD role ON conversation_messages TYPE string ASSERT $value IN ['user', 'assistant'];
DEFINE FIELD sender_id ON conversation_messages TYPE option<record<users>>;
DEFINE FIELD content ON conversation_messages TYPE string;
DEFINE FIELD tokens_used ON conversation_messages TYPE option<int>;
DEFINE FIELD created_at ON conversation_messages TYPE datetime DEFAULT time::now();
```

**Frontend Structure** (AuthSystem - BOR Pattern):
- `src/auth/firebase-config.ts` - Firebase initialization
- `src/auth/AuthSystem.ts` - Auth wrapper class (signIn, signUp, signInWithGoogle, signOut)
- `src/auth/AuthContext.tsx` - React context for auth state
- `src/components/LoginPage.tsx` - Login UI
- `src/components/SignupPage.tsx` - Signup UI

**Backend Structure**:
- `src/middleware/auth.ts` - Firebase Admin SDK token verification
- `src/services/user.ts` - User sync + management service
- `src/services/relationship.ts` - Relationship pairing service
- `src/utils/db.ts` - SurrealDB connection singleton

**Environment Variables**:
```
# SurrealDB Cloud
SURREALDB_URL=wss://mystic-jungle-06dlcjsj2pp651hvfm553m8i70.aws-euw1.surreal.cloud
SURREALDB_USER=admin
SURREALDB_PASS=rY&c2U14Bj0@S6Rk
SURREALDB_NS=couples_therapy
SURREALDB_DB=main

# Firebase Admin (from service account JSON)
FIREBASE_PROJECT_ID=weiu-fbfe2
FIREBASE_PRIVATE_KEY=<from-service-account-json>
FIREBASE_CLIENT_EMAIL=<from-service-account-json>

# Frontend URL
FRONTEND_URL=http://localhost:3000
```

**Key Implementation Points**:
- Firebase handles password hashing (no bcrypt needed)
- Firebase ID tokens verified via Admin SDK on backend
- LocalStorage keys: `firebaseUID`, `firebaseToken`, `userName`, `userEmail`
- User synced to SurrealDB on first successful Firebase auth
- Invitation tokens: 7-day expiry, UUID v4

## Dependencies

- [ ] Firebase project created (weiu-fbfe2) - DONE
- [ ] Firebase service account JSON downloaded
- [ ] SurrealDB Cloud instance (mystic-jungle) - DONE
- [ ] Node.js 20+ environment
- [ ] TypeScript, Express, Firebase Admin SDK dependencies

## Effort Estimate

- **Size**: L
- **Hours**: 40-56 hours (5-7 days)
- **Parallel**: false (foundation for all other tasks)

## Definition of Done

- [ ] Firebase Auth enabled with Email/Password + Google Sign-In
- [ ] Frontend AuthSystem class working (login, signup, Google sign-in, logout)
- [ ] Backend Firebase Admin SDK verifies tokens
- [ ] All database tables created in SurrealDB with proper schema
- [ ] User sync tested (Firebase login -> SurrealDB user record created)
- [ ] Relationship invitation tested (Partner A invites Partner B via email)
- [ ] Relationship acceptance tested (Partner B accepts, both accounts paired)
- [ ] Authorization middleware prevents users from accessing other users' data
- [ ] Unit tests written for user service, relationship service
- [ ] Integration tests for auth flow
