---
name: Exploration Chat Flow
status: closed
created: 2025-12-23T20:56:49Z
updated: 2025-12-25T17:54:31Z
github: https://github.com/vadimalpha/taskmanager/issues/15
depends_on: [13, 22]
parallel: true
conflicts_with: []
---

# Task: Exploration Chat Flow

## Description

Implement the exploration chat flow where partners have individual conversations with the AI therapist about a conflict. This replaces the form-based conflict description with a natural chat interface. Partner A creates a conflict and chats with AI until satisfied, then Partner B receives a notification and chats separately (blind input - cannot see Partner A's conversation).

## Acceptance Criteria

- [ ] ConflictStartPage: Title + privacy setting → enters chat interface
- [ ] ExplorationChat component for Partner A's individual conversation
  - Real-time AI responses (streaming via SSE)
  - Full conversation context passed to each AI message
  - Exploration system prompt (empathetic, clarifying questions)
- [ ] "I'm ready" button → finalize conversation (locks it, cannot edit)
- [ ] ConversationLock indicator when conversation is finalized
- [ ] Partner B invitation notification (sees title ONLY)
- [ ] Partner B ExplorationChat (blind - no access to Partner A's conversation)
- [ ] Backend visibility filtering (API enforces blind input)
- [ ] Conflict status tracking: `partner_a_chatting` → `pending_partner_b` → `partner_b_chatting` → `both_finalized`

## Technical Details

**Frontend Components**:
- `ConflictStartPage.tsx` - Title, privacy setting, enter chat
- `ExplorationChat.tsx` - Main exploration chat (reuses ChatWindow, ChatMessage, ChatInput)
- `ReadyButton.tsx` - "I'm ready" to finalize conversation
- `ConversationLock.tsx` - Lock indicator after finalization

**Backend Endpoints**:
- `POST /api/conflicts` - Create conflict + individual_a session
- `POST /api/conversations/:id/messages` - Send message (triggers AI response)
- `POST /api/conversations/:id/finalize` - Lock conversation
- `GET /api/conflicts/:id` - With visibility filtering based on workflow step

**Conversation Session Types**:
- `individual_a` - Partner A's exploration
- `individual_b` - Partner B's blind exploration

**System Prompt** (`exploration-system-prompt.txt`):
- Empathetic, curious tone
- Asks clarifying questions
- Validates emotions before probing deeper
- Does NOT provide advice yet (exploration phase)
- Helps identify underlying feelings and needs

**Visibility Rules (CRITICAL)**:
- Partner B cannot see Partner A's conversation until AFTER:
  1. Partner B finalizes their own conversation
  2. Partner B receives individual guidance
  3. Partner A chose "Shared" visibility
- This MUST be enforced at API level, not just UI

## Dependencies

- [ ] Task #13 complete (Database & Auth)
- [ ] Task #22 complete (Chat Infrastructure - WebSocket, ChatWindow, ChatMessage, ChatInput)
- [ ] Anthropic Claude API integration

## Effort Estimate

- **Size**: L
- **Hours**: 40-48 hours (5-6 days)
- **Parallel**: true (after Chat Infrastructure complete)

## Definition of Done

- [ ] Partner A can create conflict and chat with AI
- [ ] AI responses stream in real-time
- [ ] "I'm ready" finalizes conversation (locked)
- [ ] Partner B receives invitation, sees title only
- [ ] Partner B chats blindly (cannot access Partner A's conversation)
- [ ] Backend enforces visibility rules
- [ ] Conflict status updates through workflow
- [ ] Unit tests for visibility filtering
- [ ] E2E test: Full exploration flow for both partners
- [ ] Mobile-responsive chat interface
