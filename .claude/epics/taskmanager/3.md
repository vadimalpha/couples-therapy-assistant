---
name: Database Schema
status: in_progress
created: 2025-08-26T18:29:07Z
updated: 2025-08-26T22:58:59Z
github: https://github.com/vadimalpha/taskmanager/issues/3
depends_on: [001]
parallel: false
conflicts_with: []
---

# Task: Database Schema

## Description
Create comprehensive Supabase database schema including tables for tasks, projects, and user preferences. Implement Row Level Security (RLS) policies and create PostgreSQL functions for common operations.

## Detailed Implementation Specification

### 1. Supabase Project Setup

#### A. Create Supabase Project
1. Go to https://app.supabase.com
2. Click "New project"
3. Configure:
   - Project name: `taskmanager-prod`
   - Database Password: (generate strong password, save securely)
   - Region: Select closest to your users
   - Pricing Plan: Free tier is fine for MVP

4. Once created, get credentials from Settings > API:
   - `NEXT_PUBLIC_SUPABASE_URL`: Your project URL
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Your anon/public key
   - Save the database password securely

### 2. Database Migration Files

Create migration files in `supabase/migrations/` directory:

#### A. Create Initial Schema Migration
File: `supabase/migrations/001_initial_schema.sql`

```sql
-- Enable necessary extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm"; -- For fuzzy text search

-- Custom types
CREATE TYPE task_priority AS ENUM ('low', 'medium', 'high', 'urgent');
CREATE TYPE task_status AS ENUM ('todo', 'in_progress', 'completed', 'archived');
CREATE TYPE focus_mode AS ENUM ('daily', 'deep', 'planning', 'break');
CREATE TYPE task_quadrant AS ENUM ('urgent_important', 'not_urgent_important', 'urgent_not_important', 'not_urgent_not_important');

-- Projects table
CREATE TABLE projects (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    name VARCHAR(100) NOT NULL,
    color VARCHAR(7) NOT NULL DEFAULT '#6366f1', -- Hex color
    icon VARCHAR(50) DEFAULT 'folder',
    description TEXT,
    is_active BOOLEAN DEFAULT true,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    
    CONSTRAINT projects_name_length CHECK (char_length(name) >= 1),
    CONSTRAINT projects_color_format CHECK (color ~* '^#[0-9A-F]{6}$'),
    CONSTRAINT max_projects_per_user CHECK (
        (SELECT COUNT(*) FROM projects WHERE user_id = auth.uid() AND is_active = true) < 6
    )
);

-- Tasks table
CREATE TABLE tasks (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    project_id UUID REFERENCES projects(id) ON DELETE SET NULL,
    
    -- Basic info
    title VARCHAR(500) NOT NULL,
    description TEXT,
    
    -- Status and priority
    status task_status DEFAULT 'todo' NOT NULL,
    priority task_priority DEFAULT 'medium' NOT NULL,
    quadrant task_quadrant,
    
    -- Dates
    due_date TIMESTAMPTZ,
    scheduled_date DATE,
    completed_at TIMESTAMPTZ,
    
    -- Time estimates (in minutes)
    estimated_minutes INTEGER,
    actual_minutes INTEGER,
    
    -- Organization
    tags TEXT[] DEFAULT ARRAY[]::TEXT[],
    context VARCHAR(50), -- @home, @work, @calls, @errands
    
    -- Tracking
    energy_level VARCHAR(20), -- morning, afternoon, evening, anytime
    focus_time INTEGER, -- minutes spent in focus mode
    interruption_count INTEGER DEFAULT 0,
    
    -- Metadata
    is_recurring BOOLEAN DEFAULT false,
    recurring_config JSONB,
    parent_task_id UUID REFERENCES tasks(id) ON DELETE CASCADE,
    subtask_count INTEGER DEFAULT 0,
    attachment_count INTEGER DEFAULT 0,
    
    -- AI/Smart features
    ai_suggested_date DATE,
    ai_priority_score DECIMAL(3,2), -- 0.00 to 1.00
    auto_scheduled BOOLEAN DEFAULT false,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    
    -- Constraints
    CONSTRAINT tasks_title_length CHECK (char_length(title) >= 1),
    CONSTRAINT tasks_estimated_minutes_range CHECK (estimated_minutes >= 0 AND estimated_minutes <= 480),
    CONSTRAINT tasks_actual_minutes_range CHECK (actual_minutes >= 0),
    CONSTRAINT tasks_priority_score_range CHECK (ai_priority_score >= 0 AND ai_priority_score <= 1)
);

-- User preferences table
CREATE TABLE user_preferences (
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    
    -- Display preferences
    theme VARCHAR(20) DEFAULT 'system', -- light, dark, system
    default_view focus_mode DEFAULT 'daily',
    show_completed_tasks BOOLEAN DEFAULT false,
    
    -- Productivity settings
    daily_task_limit INTEGER DEFAULT 5,
    deep_work_duration INTEGER DEFAULT 90, -- minutes
    break_duration INTEGER DEFAULT 15, -- minutes
    
    -- Time preferences
    work_start_time TIME DEFAULT '09:00',
    work_end_time TIME DEFAULT '17:00',
    timezone VARCHAR(50) DEFAULT 'UTC',
    week_starts_on INTEGER DEFAULT 1, -- 1=Monday, 0=Sunday
    
    -- Smart features
    enable_ai_suggestions BOOLEAN DEFAULT true,
    auto_reschedule BOOLEAN DEFAULT true,
    smart_notifications BOOLEAN DEFAULT true,
    
    -- Energy patterns (JSON object with time slots)
    energy_patterns JSONB DEFAULT '{"morning": "high", "afternoon": "medium", "evening": "low"}'::jsonb,
    
    -- Notification settings
    email_notifications BOOLEAN DEFAULT true,
    push_notifications BOOLEAN DEFAULT false,
    notification_schedule JSONB DEFAULT '{"daily_summary": "08:00", "weekly_review": "friday 16:00"}'::jsonb,
    
    -- Onboarding
    has_completed_onboarding BOOLEAN DEFAULT false,
    onboarding_step INTEGER DEFAULT 0,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Focus sessions table (for analytics)
CREATE TABLE focus_sessions (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    task_id UUID REFERENCES tasks(id) ON DELETE CASCADE,
    
    mode focus_mode NOT NULL,
    started_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    ended_at TIMESTAMPTZ,
    duration_minutes INTEGER,
    
    was_interrupted BOOLEAN DEFAULT false,
    productivity_rating INTEGER CHECK (productivity_rating >= 1 AND productivity_rating <= 5),
    notes TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Task history table (for tracking changes)
CREATE TABLE task_history (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    task_id UUID REFERENCES tasks(id) ON DELETE CASCADE NOT NULL,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    
    field_changed VARCHAR(50) NOT NULL,
    old_value TEXT,
    new_value TEXT,
    
    changed_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    
    -- Index for efficient queries
    INDEX idx_task_history_task_id (task_id),
    INDEX idx_task_history_changed_at (changed_at)
);

-- Daily stats table (for analytics)
CREATE TABLE daily_stats (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    date DATE NOT NULL,
    
    tasks_created INTEGER DEFAULT 0,
    tasks_completed INTEGER DEFAULT 0,
    tasks_rescheduled INTEGER DEFAULT 0,
    
    total_focus_minutes INTEGER DEFAULT 0,
    deep_work_minutes INTEGER DEFAULT 0,
    
    productivity_score DECIMAL(3,2),
    streak_count INTEGER DEFAULT 0,
    
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    
    UNIQUE(user_id, date)
);

-- Create indexes for performance
CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_tasks_project_id ON tasks(project_id);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_due_date ON tasks(due_date);
CREATE INDEX idx_tasks_scheduled_date ON tasks(scheduled_date);
CREATE INDEX idx_tasks_created_at ON tasks(created_at);
CREATE INDEX idx_tasks_title_trgm ON tasks USING gin(title gin_trgm_ops); -- For fuzzy search

CREATE INDEX idx_projects_user_id ON projects(user_id);
CREATE INDEX idx_projects_is_active ON projects(is_active);

CREATE INDEX idx_focus_sessions_user_id ON focus_sessions(user_id);
CREATE INDEX idx_focus_sessions_task_id ON focus_sessions(task_id);
CREATE INDEX idx_focus_sessions_started_at ON focus_sessions(started_at);

CREATE INDEX idx_daily_stats_user_id_date ON daily_stats(user_id, date);
```

### 3. Row Level Security (RLS) Policies

File: `supabase/migrations/002_rls_policies.sql`

```sql
-- Enable RLS on all tables
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_preferences ENABLE ROW LEVEL SECURITY;
ALTER TABLE focus_sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE task_history ENABLE ROW LEVEL SECURITY;
ALTER TABLE daily_stats ENABLE ROW LEVEL SECURITY;

-- Projects policies
CREATE POLICY "Users can view own projects" ON projects
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can create own projects" ON projects
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own projects" ON projects
    FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own projects" ON projects
    FOR DELETE USING (auth.uid() = user_id);

-- Tasks policies
CREATE POLICY "Users can view own tasks" ON tasks
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can create own tasks" ON tasks
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own tasks" ON tasks
    FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own tasks" ON tasks
    FOR DELETE USING (auth.uid() = user_id);

-- User preferences policies
CREATE POLICY "Users can view own preferences" ON user_preferences
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own preferences" ON user_preferences
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own preferences" ON user_preferences
    FOR UPDATE USING (auth.uid() = user_id);

-- Focus sessions policies
CREATE POLICY "Users can view own focus sessions" ON focus_sessions
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can create own focus sessions" ON focus_sessions
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own focus sessions" ON focus_sessions
    FOR UPDATE USING (auth.uid() = user_id);

-- Task history policies
CREATE POLICY "Users can view own task history" ON task_history
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can create own task history" ON task_history
    FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Daily stats policies
CREATE POLICY "Users can view own daily stats" ON daily_stats
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can create own daily stats" ON daily_stats
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own daily stats" ON daily_stats
    FOR UPDATE USING (auth.uid() = user_id);
```

### 4. Database Functions

File: `supabase/migrations/003_functions.sql`

```sql
-- Function to get today's prioritized tasks
CREATE OR REPLACE FUNCTION get_todays_tasks(
    p_user_id UUID,
    p_limit INTEGER DEFAULT 5
)
RETURNS TABLE (
    id UUID,
    title VARCHAR,
    description TEXT,
    priority task_priority,
    quadrant task_quadrant,
    due_date TIMESTAMPTZ,
    project_id UUID,
    project_name VARCHAR,
    project_color VARCHAR,
    estimated_minutes INTEGER,
    ai_priority_score DECIMAL
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        t.id,
        t.title,
        t.description,
        t.priority,
        t.quadrant,
        t.due_date,
        t.project_id,
        p.name as project_name,
        p.color as project_color,
        t.estimated_minutes,
        COALESCE(t.ai_priority_score, 
            -- Calculate priority score if not set
            CASE 
                WHEN t.due_date < NOW() THEN 1.0  -- Overdue
                WHEN t.due_date < NOW() + INTERVAL '1 day' THEN 0.9  -- Due today
                WHEN t.priority = 'urgent' THEN 0.8
                WHEN t.priority = 'high' THEN 0.6
                WHEN t.priority = 'medium' THEN 0.4
                ELSE 0.2
            END
        ) as ai_priority_score
    FROM tasks t
    LEFT JOIN projects p ON t.project_id = p.id
    WHERE t.user_id = p_user_id
        AND t.status IN ('todo', 'in_progress')
        AND (
            t.scheduled_date = CURRENT_DATE 
            OR t.due_date <= NOW() + INTERVAL '1 day'
            OR (t.scheduled_date IS NULL AND t.due_date IS NULL AND t.priority IN ('urgent', 'high'))
        )
    ORDER BY 
        -- Overdue tasks first
        CASE WHEN t.due_date < NOW() THEN 0 ELSE 1 END,
        -- Then by priority score
        ai_priority_score DESC,
        -- Then by due date
        t.due_date ASC NULLS LAST,
        -- Finally by creation date
        t.created_at ASC
    LIMIT p_limit;
END;
$$;

-- Function to auto-reschedule overdue tasks
CREATE OR REPLACE FUNCTION auto_reschedule_overdue_tasks(p_user_id UUID)
RETURNS INTEGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_count INTEGER := 0;
BEGIN
    UPDATE tasks
    SET 
        scheduled_date = CURRENT_DATE,
        auto_scheduled = true,
        updated_at = NOW()
    WHERE user_id = p_user_id
        AND status = 'todo'
        AND due_date < CURRENT_DATE
        AND (scheduled_date IS NULL OR scheduled_date < CURRENT_DATE);
    
    GET DIAGNOSTICS v_count = ROW_COUNT;
    RETURN v_count;
END;
$$;

-- Function to calculate daily streak
CREATE OR REPLACE FUNCTION calculate_streak(p_user_id UUID)
RETURNS INTEGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_streak INTEGER := 0;
    v_date DATE := CURRENT_DATE;
    v_found BOOLEAN;
BEGIN
    LOOP
        SELECT EXISTS(
            SELECT 1 FROM daily_stats 
            WHERE user_id = p_user_id 
                AND date = v_date 
                AND tasks_completed > 0
        ) INTO v_found;
        
        EXIT WHEN NOT v_found;
        
        v_streak := v_streak + 1;
        v_date := v_date - INTERVAL '1 day';
    END LOOP;
    
    RETURN v_streak;
END;
$$;

-- Function to update daily stats
CREATE OR REPLACE FUNCTION update_daily_stats(p_user_id UUID, p_date DATE DEFAULT CURRENT_DATE)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_tasks_created INTEGER;
    v_tasks_completed INTEGER;
    v_tasks_rescheduled INTEGER;
    v_focus_minutes INTEGER;
    v_deep_work_minutes INTEGER;
    v_productivity_score DECIMAL(3,2);
BEGIN
    -- Count tasks created today
    SELECT COUNT(*) INTO v_tasks_created
    FROM tasks
    WHERE user_id = p_user_id
        AND DATE(created_at) = p_date;
    
    -- Count tasks completed today
    SELECT COUNT(*) INTO v_tasks_completed
    FROM tasks
    WHERE user_id = p_user_id
        AND DATE(completed_at) = p_date;
    
    -- Count rescheduled tasks
    SELECT COUNT(*) INTO v_tasks_rescheduled
    FROM task_history
    WHERE user_id = p_user_id
        AND DATE(changed_at) = p_date
        AND field_changed = 'scheduled_date';
    
    -- Calculate focus minutes
    SELECT 
        COALESCE(SUM(duration_minutes), 0),
        COALESCE(SUM(CASE WHEN mode = 'deep' THEN duration_minutes ELSE 0 END), 0)
    INTO v_focus_minutes, v_deep_work_minutes
    FROM focus_sessions
    WHERE user_id = p_user_id
        AND DATE(started_at) = p_date;
    
    -- Calculate productivity score (simple formula, can be enhanced)
    v_productivity_score := LEAST(1.0, 
        (v_tasks_completed::DECIMAL / GREATEST(5, v_tasks_created)) * 0.5 +
        (v_focus_minutes::DECIMAL / 240) * 0.3 +  -- 4 hours target
        (v_deep_work_minutes::DECIMAL / 90) * 0.2  -- 90 minutes target
    );
    
    -- Insert or update daily stats
    INSERT INTO daily_stats (
        user_id, date, tasks_created, tasks_completed, 
        tasks_rescheduled, total_focus_minutes, deep_work_minutes,
        productivity_score, streak_count
    )
    VALUES (
        p_user_id, p_date, v_tasks_created, v_tasks_completed,
        v_tasks_rescheduled, v_focus_minutes, v_deep_work_minutes,
        v_productivity_score, calculate_streak(p_user_id)
    )
    ON CONFLICT (user_id, date) DO UPDATE SET
        tasks_created = EXCLUDED.tasks_created,
        tasks_completed = EXCLUDED.tasks_completed,
        tasks_rescheduled = EXCLUDED.tasks_rescheduled,
        total_focus_minutes = EXCLUDED.total_focus_minutes,
        deep_work_minutes = EXCLUDED.deep_work_minutes,
        productivity_score = EXCLUDED.productivity_score,
        streak_count = EXCLUDED.streak_count;
END;
$$;

-- Function to get task suggestions based on energy levels
CREATE OR REPLACE FUNCTION get_energy_based_suggestions(
    p_user_id UUID,
    p_time_of_day VARCHAR DEFAULT NULL
)
RETURNS TABLE (
    id UUID,
    title VARCHAR,
    energy_level VARCHAR,
    estimated_minutes INTEGER,
    priority task_priority
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_energy_level VARCHAR;
BEGIN
    -- Determine energy level based on time of day
    IF p_time_of_day IS NULL THEN
        SELECT 
            CASE 
                WHEN EXTRACT(HOUR FROM NOW()) < 12 THEN 'morning'
                WHEN EXTRACT(HOUR FROM NOW()) < 17 THEN 'afternoon'
                ELSE 'evening'
            END INTO v_energy_level;
    ELSE
        v_energy_level := p_time_of_day;
    END IF;
    
    RETURN QUERY
    SELECT 
        t.id,
        t.title,
        t.energy_level,
        t.estimated_minutes,
        t.priority
    FROM tasks t
    WHERE t.user_id = p_user_id
        AND t.status = 'todo'
        AND (t.energy_level = v_energy_level OR t.energy_level = 'anytime' OR t.energy_level IS NULL)
    ORDER BY 
        CASE WHEN t.energy_level = v_energy_level THEN 0 ELSE 1 END,
        t.priority DESC,
        t.created_at ASC
    LIMIT 5;
END;
$$;

-- Function to archive completed tasks older than 30 days
CREATE OR REPLACE FUNCTION archive_old_completed_tasks()
RETURNS INTEGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_count INTEGER;
BEGIN
    UPDATE tasks
    SET status = 'archived'
    WHERE status = 'completed'
        AND completed_at < NOW() - INTERVAL '30 days';
    
    GET DIAGNOSTICS v_count = ROW_COUNT;
    RETURN v_count;
END;
$$;
```

### 5. Triggers

File: `supabase/migrations/004_triggers.sql`

```sql
-- Trigger to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply updated_at trigger to all tables
CREATE TRIGGER update_projects_updated_at BEFORE UPDATE ON projects
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_tasks_updated_at BEFORE UPDATE ON tasks
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_user_preferences_updated_at BEFORE UPDATE ON user_preferences
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Trigger to track task changes
CREATE OR REPLACE FUNCTION track_task_changes()
RETURNS TRIGGER AS $$
BEGIN
    -- Track status changes
    IF OLD.status IS DISTINCT FROM NEW.status THEN
        INSERT INTO task_history (task_id, user_id, field_changed, old_value, new_value)
        VALUES (NEW.id, NEW.user_id, 'status', OLD.status::TEXT, NEW.status::TEXT);
    END IF;
    
    -- Track scheduled_date changes
    IF OLD.scheduled_date IS DISTINCT FROM NEW.scheduled_date THEN
        INSERT INTO task_history (task_id, user_id, field_changed, old_value, new_value)
        VALUES (NEW.id, NEW.user_id, 'scheduled_date', OLD.scheduled_date::TEXT, NEW.scheduled_date::TEXT);
    END IF;
    
    -- Track priority changes
    IF OLD.priority IS DISTINCT FROM NEW.priority THEN
        INSERT INTO task_history (task_id, user_id, field_changed, old_value, new_value)
        VALUES (NEW.id, NEW.user_id, 'priority', OLD.priority::TEXT, NEW.priority::TEXT);
    END IF;
    
    -- Update completed_at when task is completed
    IF OLD.status != 'completed' AND NEW.status = 'completed' THEN
        NEW.completed_at = NOW();
    ELSIF OLD.status = 'completed' AND NEW.status != 'completed' THEN
        NEW.completed_at = NULL;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER track_task_changes_trigger BEFORE UPDATE ON tasks
    FOR EACH ROW EXECUTE FUNCTION track_task_changes();

-- Trigger to update subtask count
CREATE OR REPLACE FUNCTION update_subtask_count()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' AND NEW.parent_task_id IS NOT NULL THEN
        UPDATE tasks 
        SET subtask_count = subtask_count + 1
        WHERE id = NEW.parent_task_id;
    ELSIF TG_OP = 'DELETE' AND OLD.parent_task_id IS NOT NULL THEN
        UPDATE tasks 
        SET subtask_count = subtask_count - 1
        WHERE id = OLD.parent_task_id;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_subtask_count_trigger 
AFTER INSERT OR DELETE ON tasks
    FOR EACH ROW EXECUTE FUNCTION update_subtask_count();

-- Trigger to create default user preferences
CREATE OR REPLACE FUNCTION create_default_preferences()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO user_preferences (user_id)
    VALUES (NEW.id)
    ON CONFLICT (user_id) DO NOTHING;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- This trigger would be created on auth.users table if we had access
-- For now, preferences will be created on first login via application code
```

### 6. Sample Data for Testing

File: `supabase/migrations/005_sample_data.sql`

```sql
-- This migration is only for development/testing
-- Comment out or delete for production

DO $$
DECLARE
    v_user_id UUID;
    v_project1_id UUID;
    v_project2_id UUID;
BEGIN
    -- Get the first user or create a test user
    SELECT id INTO v_user_id FROM auth.users LIMIT 1;
    
    IF v_user_id IS NULL THEN
        -- In production, users are created via auth
        -- This is just for testing
        RAISE NOTICE 'No users found. Create a user via Supabase Auth first.';
        RETURN;
    END IF;
    
    -- Insert sample projects
    INSERT INTO projects (id, user_id, name, color, icon, description, sort_order)
    VALUES 
        (uuid_generate_v4(), v_user_id, 'Personal', '#10b981', 'user', 'Personal tasks and goals', 0),
        (uuid_generate_v4(), v_user_id, 'Work', '#3b82f6', 'briefcase', 'Work-related tasks', 1),
        (uuid_generate_v4(), v_user_id, 'Learning', '#f59e0b', 'book', 'Learning and development', 2)
    RETURNING id INTO v_project1_id;
    
    SELECT id INTO v_project2_id FROM projects WHERE user_id = v_user_id AND name = 'Work';
    
    -- Insert sample tasks
    INSERT INTO tasks (user_id, project_id, title, description, priority, status, due_date, estimated_minutes, energy_level, tags)
    VALUES 
        (v_user_id, v_project1_id, 'Set up development environment', 'Install all necessary tools and dependencies', 'high', 'todo', NOW() + INTERVAL '1 day', 120, 'morning', ARRAY['setup', 'important']),
        (v_user_id, v_project1_id, 'Review PRD documentation', 'Read through the product requirements', 'medium', 'todo', NOW() + INTERVAL '2 days', 60, 'afternoon', ARRAY['documentation']),
        (v_user_id, v_project2_id, 'Team standup meeting', 'Daily sync with the team', 'medium', 'todo', NOW() + INTERVAL '3 hours', 15, 'morning', ARRAY['meeting', 'recurring']),
        (v_user_id, v_project2_id, 'Code review for PR #123', 'Review pull request from teammate', 'high', 'in_progress', NOW() + INTERVAL '4 hours', 45, 'anytime', ARRAY['review', 'collaboration']),
        (v_user_id, NULL, 'Buy groceries', 'Weekly grocery shopping', 'low', 'todo', NOW() + INTERVAL '2 days', 60, 'evening', ARRAY['personal', 'errands']);
    
    -- Insert user preferences
    INSERT INTO user_preferences (user_id, theme, default_view, daily_task_limit, work_start_time, work_end_time)
    VALUES (v_user_id, 'system', 'daily', 5, '09:00', '18:00')
    ON CONFLICT (user_id) DO NOTHING;
    
    RAISE NOTICE 'Sample data inserted successfully';
END $$;
```

### 7. TypeScript Types Generation

After creating the database schema, generate TypeScript types:

```bash
# Install Supabase CLI
npm install -g supabase

# Login to Supabase
supabase login

# Initialize Supabase in project
supabase init

# Link to your project
supabase link --project-ref <your-project-ref>

# Generate types
supabase gen types typescript --linked > types/database.ts
```

### 8. Database Type Definitions

File: `types/database.ts` (example structure after generation):

```typescript
export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export interface Database {
  public: {
    Tables: {
      projects: {
        Row: {
          id: string
          user_id: string
          name: string
          color: string
          icon: string | null
          description: string | null
          is_active: boolean
          sort_order: number
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          user_id: string
          name: string
          color?: string
          icon?: string | null
          description?: string | null
          is_active?: boolean
          sort_order?: number
          created_at?: string
          updated_at?: string
        }
        Update: {
          id?: string
          user_id?: string
          name?: string
          color?: string
          icon?: string | null
          description?: string | null
          is_active?: boolean
          sort_order?: number
          created_at?: string
          updated_at?: string
        }
      }
      tasks: {
        Row: {
          id: string
          user_id: string
          project_id: string | null
          title: string
          description: string | null
          status: 'todo' | 'in_progress' | 'completed' | 'archived'
          priority: 'low' | 'medium' | 'high' | 'urgent'
          quadrant: 'urgent_important' | 'not_urgent_important' | 'urgent_not_important' | 'not_urgent_not_important' | null
          due_date: string | null
          scheduled_date: string | null
          completed_at: string | null
          estimated_minutes: number | null
          actual_minutes: number | null
          tags: string[]
          context: string | null
          energy_level: string | null
          focus_time: number | null
          interruption_count: number
          is_recurring: boolean
          recurring_config: Json | null
          parent_task_id: string | null
          subtask_count: number
          attachment_count: number
          ai_suggested_date: string | null
          ai_priority_score: number | null
          auto_scheduled: boolean
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          user_id: string
          project_id?: string | null
          title: string
          description?: string | null
          status?: 'todo' | 'in_progress' | 'completed' | 'archived'
          priority?: 'low' | 'medium' | 'high' | 'urgent'
          quadrant?: 'urgent_important' | 'not_urgent_important' | 'urgent_not_important' | 'not_urgent_not_important' | null
          due_date?: string | null
          scheduled_date?: string | null
          completed_at?: string | null
          estimated_minutes?: number | null
          actual_minutes?: number | null
          tags?: string[]
          context?: string | null
          energy_level?: string | null
          focus_time?: number | null
          interruption_count?: number
          is_recurring?: boolean
          recurring_config?: Json | null
          parent_task_id?: string | null
          subtask_count?: number
          attachment_count?: number
          ai_suggested_date?: string | null
          ai_priority_score?: number | null
          auto_scheduled?: boolean
          created_at?: string
          updated_at?: string
        }
        Update: {
          // Similar structure to Insert
        }
      }
      user_preferences: {
        // Similar structure
      }
      focus_sessions: {
        // Similar structure
      }
      task_history: {
        // Similar structure
      }
      daily_stats: {
        // Similar structure
      }
    }
    Views: {
      // Any database views
    }
    Functions: {
      get_todays_tasks: {
        Args: {
          p_user_id: string
          p_limit?: number
        }
        Returns: Array<{
          id: string
          title: string
          description: string | null
          priority: string
          quadrant: string | null
          due_date: string | null
          project_id: string | null
          project_name: string | null
          project_color: string | null
          estimated_minutes: number | null
          ai_priority_score: number
        }>
      }
      auto_reschedule_overdue_tasks: {
        Args: {
          p_user_id: string
        }
        Returns: number
      }
      calculate_streak: {
        Args: {
          p_user_id: string
        }
        Returns: number
      }
      update_daily_stats: {
        Args: {
          p_user_id: string
          p_date?: string
        }
        Returns: void
      }
      get_energy_based_suggestions: {
        Args: {
          p_user_id: string
          p_time_of_day?: string
        }
        Returns: Array<{
          id: string
          title: string
          energy_level: string | null
          estimated_minutes: number | null
          priority: string
        }>
      }
      archive_old_completed_tasks: {
        Args: Record<string, never>
        Returns: number
      }
    }
    Enums: {
      task_priority: 'low' | 'medium' | 'high' | 'urgent'
      task_status: 'todo' | 'in_progress' | 'completed' | 'archived'
      focus_mode: 'daily' | 'deep' | 'planning' | 'break'
      task_quadrant: 'urgent_important' | 'not_urgent_important' | 'urgent_not_important' | 'not_urgent_not_important'
    }
  }
}
```

### 9. Testing the Schema

Run these queries in Supabase SQL Editor to test:

```sql
-- Test user creation and preferences
SELECT * FROM auth.users;
SELECT * FROM user_preferences;

-- Test project creation
INSERT INTO projects (user_id, name, color) 
VALUES (auth.uid(), 'Test Project', '#ff0000');

-- Test task creation
INSERT INTO tasks (user_id, title, priority, due_date)
VALUES (auth.uid(), 'Test Task', 'high', NOW() + INTERVAL '1 day');

-- Test get_todays_tasks function
SELECT * FROM get_todays_tasks(auth.uid(), 5);

-- Test auto reschedule
SELECT auto_reschedule_overdue_tasks(auth.uid());

-- Test streak calculation
SELECT calculate_streak(auth.uid());

-- Test daily stats update
SELECT update_daily_stats(auth.uid());
```

## Acceptance Criteria
- [ ] Supabase project created and configured
- [ ] All tables created with proper data types and constraints
- [ ] RLS policies implemented for all tables
- [ ] All database functions created and tested
- [ ] All triggers functioning correctly
- [ ] Indexes created for performance optimization
- [ ] TypeScript types generated from schema
- [ ] Sample data loaded for testing
- [ ] All functions return expected results
- [ ] Performance queries execute in < 100ms

## Dependencies
- [ ] Task 001 completed (Supabase configured)
- [ ] Supabase CLI installed for migrations
- [ ] Database connection established

## Effort Estimate
- Size: M
- Hours: 4
- Parallel: false

## Definition of Done
- [ ] All migration files created
- [ ] Schema deployed to Supabase
- [ ] RLS policies verified working
- [ ] Database functions tested
- [ ] TypeScript types generated
- [ ] Documentation updated with schema details
- [ ] No SQL errors in migrations
- [ ] All constraints validated
- [ ] Performance benchmarks met
