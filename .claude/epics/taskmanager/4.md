---
name: Authentication Flow
status: open
created: 2025-08-26T18:29:07Z
updated: 2025-08-26T20:52:21Z
github: https://github.com/vadimalpha/taskmanager/issues/4
depends_on: [002]
parallel: false
conflicts_with: []
---

# Task: Authentication Flow

## Description
Implement comprehensive user authentication using Supabase Auth with custom UI components, including sign-up, login, password reset, session management, and protected routes with proper error handling and loading states.

## Detailed Implementation Specification

### 1. Auth Store Implementation

#### Create `stores/authStore.ts`:
```typescript
import { create } from 'zustand'
import { devtools, persist } from 'zustand/middleware'
import { User } from '@supabase/supabase-js'

interface AuthState {
  user: User | null
  session: any | null
  loading: boolean
  initialized: boolean
  setAuth: (user: User | null, session: any | null) => void
  setLoading: (loading: boolean) => void
  setInitialized: (initialized: boolean) => void
  clearAuth: () => void
}

export const useAuthStore = create<AuthState>()(
  devtools(
    persist(
      (set) => ({
        user: null,
        session: null,
        loading: true,
        initialized: false,
        setAuth: (user, session) => 
          set({ user, session, loading: false, initialized: true }),
        setLoading: (loading) => set({ loading }),
        setInitialized: (initialized) => set({ initialized }),
        clearAuth: () => 
          set({ user: null, session: null, loading: false, initialized: true }),
      }),
      {
        name: 'auth-storage',
        partialize: (state) => ({ 
          user: state.user,
          session: state.session,
          initialized: state.initialized 
        }),
      }
    ),
    { name: 'AuthStore' }
  )
)
```

### 2. Auth Provider Component

#### Create `components/providers/AuthProvider.tsx`:
```typescript
'use client'

import { createContext, useContext, useEffect } from 'react'
import { createClient } from '@/lib/supabase/client'
import { useAuthStore } from '@/stores/authStore'
import { useRouter } from 'next/navigation'
import { toast } from 'sonner'
import { User, Session } from '@supabase/supabase-js'

interface AuthContextType {
  user: User | null
  session: Session | null
  loading: boolean
  initialized: boolean
  signUp: (email: string, password: string, metadata?: any) => Promise<void>
  signIn: (email: string, password: string) => Promise<void>
  signOut: () => Promise<void>
  resetPassword: (email: string) => Promise<void>
  updatePassword: (password: string) => Promise<void>
}

const AuthContext = createContext<AuthContextType | undefined>(undefined)

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const { 
    user, 
    session, 
    loading, 
    initialized,
    setAuth, 
    setLoading, 
    setInitialized,
    clearAuth 
  } = useAuthStore()
  
  const router = useRouter()
  const supabase = createClient()

  useEffect(() => {
    let mounted = true

    async function getInitialSession() {
      try {
        setLoading(true)
        const { data: { session }, error } = await supabase.auth.getSession()
        
        if (error) {
          console.error('Error getting session:', error.message)
          toast.error('Session error: ' + error.message)
        }
        
        if (mounted) {
          if (session) {
            setAuth(session.user, session)
            // Create user preferences if they don't exist
            await createUserPreferences(session.user.id)
          } else {
            clearAuth()
          }
        }
      } catch (error) {
        console.error('Error in getInitialSession:', error)
        if (mounted) {
          clearAuth()
        }
      } finally {
        if (mounted) {
          setLoading(false)
          setInitialized(true)
        }
      }
    }

    getInitialSession()

    // Listen for auth state changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        if (!mounted) return

        console.log('Auth state changed:', event, session?.user?.id)

        switch (event) {
          case 'SIGNED_IN':
            if (session) {
              setAuth(session.user, session)
              await createUserPreferences(session.user.id)
              toast.success('Successfully signed in!')
              router.push('/dashboard')
            }
            break
          
          case 'SIGNED_OUT':
            clearAuth()
            toast.info('Signed out successfully')
            router.push('/login')
            break
          
          case 'PASSWORD_RECOVERY':
            toast.info('Password recovery email sent')
            break
          
          case 'TOKEN_REFRESHED':
            if (session) {
              setAuth(session.user, session)
            }
            break
          
          case 'USER_UPDATED':
            if (session) {
              setAuth(session.user, session)
              toast.success('Profile updated successfully')
            }
            break
        }
      }
    )

    return () => {
      mounted = false
      subscription.unsubscribe()
    }
  }, [])

  // Create user preferences on first login
  async function createUserPreferences(userId: string) {
    try {
      const { error } = await supabase
        .from('user_preferences')
        .insert([{ user_id: userId }])
        .select()
        .single()

      // Ignore conflict errors (preferences already exist)
      if (error && !error.message.includes('duplicate key')) {
        console.error('Error creating user preferences:', error)
      }
    } catch (error) {
      console.error('Error in createUserPreferences:', error)
    }
  }

  const signUp = async (email: string, password: string, metadata?: any) => {
    try {
      setLoading(true)
      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: metadata,
          emailRedirectTo: `${window.location.origin}/auth/callback`
        }
      })

      if (error) {
        throw error
      }

      toast.success('Check your email to confirm your account!')
    } catch (error: any) {
      console.error('Sign up error:', error)
      toast.error(error.message || 'An error occurred during sign up')
      throw error
    } finally {
      setLoading(false)
    }
  }

  const signIn = async (email: string, password: string) => {
    try {
      setLoading(true)
      const { error } = await supabase.auth.signInWithPassword({
        email,
        password,
      })

      if (error) {
        throw error
      }

      // Success is handled by onAuthStateChange
    } catch (error: any) {
      console.error('Sign in error:', error)
      toast.error(error.message || 'An error occurred during sign in')
      throw error
    } finally {
      setLoading(false)
    }
  }

  const signOut = async () => {
    try {
      setLoading(true)
      const { error } = await supabase.auth.signOut()

      if (error) {
        throw error
      }

      // Success is handled by onAuthStateChange
    } catch (error: any) {
      console.error('Sign out error:', error)
      toast.error(error.message || 'An error occurred during sign out')
      throw error
    } finally {
      setLoading(false)
    }
  }

  const resetPassword = async (email: string) => {
    try {
      setLoading(true)
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${window.location.origin}/auth/reset-password`
      })

      if (error) {
        throw error
      }

      toast.success('Password reset email sent!')
    } catch (error: any) {
      console.error('Password reset error:', error)
      toast.error(error.message || 'An error occurred sending reset email')
      throw error
    } finally {
      setLoading(false)
    }
  }

  const updatePassword = async (password: string) => {
    try {
      setLoading(true)
      const { error } = await supabase.auth.updateUser({
        password
      })

      if (error) {
        throw error
      }

      toast.success('Password updated successfully!')
    } catch (error: any) {
      console.error('Password update error:', error)
      toast.error(error.message || 'An error occurred updating password')
      throw error
    } finally {
      setLoading(false)
    }
  }

  const value = {
    user,
    session,
    loading,
    initialized,
    signUp,
    signIn,
    signOut,
    resetPassword,
    updatePassword,
  }

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  )
}

export function useAuth() {
  const context = useContext(AuthContext)
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider')
  }
  return context
}
```

### 3. Custom Auth Hooks

#### Create `hooks/useAuth.ts`:
```typescript
import { useAuth as useAuthContext } from '@/components/providers/AuthProvider'
import { useAuthStore } from '@/stores/authStore'

// Convenience hook that combines context and store
export function useAuth() {
  const authContext = useAuthContext()
  const authStore = useAuthStore()

  return {
    ...authContext,
    // Additional computed properties
    isAuthenticated: !!authStore.user,
    isLoading: authStore.loading,
    userId: authStore.user?.id,
    userEmail: authStore.user?.email,
  }
}

export function useRequireAuth() {
  const { user, loading, initialized } = useAuth()
  
  return {
    user,
    loading: loading || !initialized,
    authenticated: !!user,
  }
}
```

### 4. Auth Layout Components

#### Create `app/(auth)/layout.tsx`:
```typescript
import { Suspense } from 'react'
import { AuthLayoutClient } from './AuthLayoutClient'

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="min-h-screen flex">
      {/* Left side - Hero/Branding */}
      <div className="hidden lg:flex lg:w-1/2 bg-gradient-to-br from-blue-600 via-purple-600 to-indigo-800 relative overflow-hidden">
        <div className="absolute inset-0 bg-black/20" />
        <div className="relative z-10 flex flex-col justify-center px-12 text-white">
          <h1 className="text-4xl font-bold mb-6">
            Welcome to TaskManager
          </h1>
          <p className="text-xl opacity-90 mb-8">
            Smart personal productivity that adapts to your workflow. 
            Organize tasks, stay focused, and achieve more with less effort.
          </p>
          <div className="space-y-4">
            <div className="flex items-center space-x-3">
              <div className="w-5 h-5 bg-green-400 rounded-full flex items-center justify-center">
                ✓
              </div>
              <span>Smart prioritization with Eisenhower Matrix</span>
            </div>
            <div className="flex items-center space-x-3">
              <div className="w-5 h-5 bg-green-400 rounded-full flex items-center justify-center">
                ✓
              </div>
              <span>Focus modes for different work styles</span>
            </div>
            <div className="flex items-center space-x-3">
              <div className="w-5 h-5 bg-green-400 rounded-full flex items-center justify-center">
                ✓
              </div>
              <span>Natural language task capture</span>
            </div>
          </div>
        </div>
        
        {/* Decorative elements */}
        <div className="absolute top-20 right-20 w-32 h-32 bg-white/10 rounded-full blur-xl" />
        <div className="absolute bottom-20 left-20 w-24 h-24 bg-white/5 rounded-full blur-lg" />
      </div>

      {/* Right side - Auth forms */}
      <div className="flex-1 flex flex-col justify-center px-4 sm:px-6 lg:px-8">
        <div className="mx-auto w-full max-w-md">
          <Suspense fallback={
            <div className="flex items-center justify-center p-8">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600" />
            </div>
          }>
            <AuthLayoutClient>
              {children}
            </AuthLayoutClient>
          </Suspense>
        </div>
      </div>
    </div>
  )
}
```

#### Create `app/(auth)/AuthLayoutClient.tsx`:
```typescript
'use client'

import { useAuth } from '@/hooks/useAuth'
import { useRouter } from 'next/navigation'
import { useEffect } from 'react'

export function AuthLayoutClient({ children }: { children: React.ReactNode }) {
  const { user, loading, initialized } = useAuth()
  const router = useRouter()

  useEffect(() => {
    if (initialized && !loading && user) {
      router.push('/dashboard')
    }
  }, [user, loading, initialized, router])

  if (!initialized || loading) {
    return (
      <div className="flex items-center justify-center p-8">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600" />
      </div>
    )
  }

  if (user) {
    return (
      <div className="flex items-center justify-center p-8">
        <div>Redirecting to dashboard...</div>
      </div>
    )
  }

  return <>{children}</>
}
```

### 5. Login Page

#### Create `app/(auth)/login/page.tsx`:
```typescript
'use client'

import { useState } from 'react'
import { useAuth } from '@/hooks/useAuth'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Checkbox } from '@/components/ui/checkbox'
import { Separator } from '@/components/ui/separator'
import Link from 'next/link'
import { Eye, EyeOff, Mail, Lock, ArrowRight } from 'lucide-react'

export default function LoginPage() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [showPassword, setShowPassword] = useState(false)
  const [rememberMe, setRememberMe] = useState(true)
  const [isSubmitting, setIsSubmitting] = useState(false)
  
  const { signIn, loading } = useAuth()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (isSubmitting || loading) return

    try {
      setIsSubmitting(true)
      await signIn(email, password)
    } catch (error) {
      console.error('Login failed:', error)
    } finally {
      setIsSubmitting(false)
    }
  }

  const isFormValid = email.length > 0 && password.length >= 6
  const isLoading = loading || isSubmitting

  return (
    <div className="space-y-6">
      <div className="text-center">
        <h1 className="text-2xl font-bold text-gray-900">Welcome back</h1>
        <p className="mt-2 text-gray-600">
          Sign in to your account to continue
        </p>
      </div>

      <form onSubmit={handleSubmit} className="space-y-4">
        <div className="space-y-2">
          <Label htmlFor="email">Email address</Label>
          <div className="relative">
            <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
            <Input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder="Enter your email"
              className="pl-10"
              required
              disabled={isLoading}
              autoComplete="email"
            />
          </div>
        </div>

        <div className="space-y-2">
          <Label htmlFor="password">Password</Label>
          <div className="relative">
            <Lock className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
            <Input
              id="password"
              type={showPassword ? 'text' : 'password'}
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="Enter your password"
              className="pl-10 pr-10"
              required
              minLength={6}
              disabled={isLoading}
              autoComplete="current-password"
            />
            <button
              type="button"
              onClick={() => setShowPassword(!showPassword)}
              className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
              disabled={isLoading}
            >
              {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
            </button>
          </div>
        </div>

        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-2">
            <Checkbox
              id="remember"
              checked={rememberMe}
              onCheckedChange={setRememberMe}
              disabled={isLoading}
            />
            <Label htmlFor="remember" className="text-sm text-gray-600">
              Remember me
            </Label>
          </div>
          <Link 
            href="/forgot-password" 
            className="text-sm text-blue-600 hover:text-blue-500"
          >
            Forgot password?
          </Link>
        </div>

        <Button
          type="submit"
          className="w-full"
          disabled={!isFormValid || isLoading}
        >
          {isLoading ? (
            <div className="flex items-center space-x-2">
              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white" />
              <span>Signing in...</span>
            </div>
          ) : (
            <div className="flex items-center space-x-2">
              <span>Sign in</span>
              <ArrowRight className="h-4 w-4" />
            </div>
          )}
        </Button>
      </form>

      <div className="relative">
        <div className="absolute inset-0 flex items-center">
          <Separator className="w-full" />
        </div>
        <div className="relative flex justify-center text-xs uppercase">
          <span className="bg-white px-2 text-gray-500">New to TaskManager?</span>
        </div>
      </div>

      <div className="text-center">
        <Link href="/signup">
          <Button variant="outline" className="w-full">
            Create an account
          </Button>
        </Link>
      </div>
    </div>
  )
}
```

### 6. Sign Up Page

#### Create `app/(auth)/signup/page.tsx`:
```typescript
'use client'

import { useState } from 'react'
import { useAuth } from '@/hooks/useAuth'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Checkbox } from '@/components/ui/checkbox'
import { Separator } from '@/components/ui/separator'
import Link from 'next/link'
import { Eye, EyeOff, Mail, Lock, User, ArrowRight } from 'lucide-react'

export default function SignUpPage() {
  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    email: '',
    password: '',
    confirmPassword: ''
  })
  const [showPassword, setShowPassword] = useState(false)
  const [showConfirmPassword, setShowConfirmPassword] = useState(false)
  const [acceptTerms, setAcceptTerms] = useState(false)
  const [isSubmitting, setIsSubmitting] = useState(false)
  
  const { signUp, loading } = useAuth()

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setFormData(prev => ({
      ...prev,
      [e.target.name]: e.target.value
    }))
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (isSubmitting || loading) return

    try {
      setIsSubmitting(true)
      await signUp(formData.email, formData.password, {
        first_name: formData.firstName,
        last_name: formData.lastName,
        full_name: `${formData.firstName} ${formData.lastName}`.trim()
      })
    } catch (error) {
      console.error('Sign up failed:', error)
    } finally {
      setIsSubmitting(false)
    }
  }

  // Form validation
  const isFormValid = 
    formData.firstName.length > 0 &&
    formData.lastName.length > 0 &&
    formData.email.length > 0 &&
    formData.password.length >= 6 &&
    formData.password === formData.confirmPassword &&
    acceptTerms

  const passwordsMatch = formData.password === formData.confirmPassword || formData.confirmPassword === ''
  const isLoading = loading || isSubmitting

  return (
    <div className="space-y-6">
      <div className="text-center">
        <h1 className="text-2xl font-bold text-gray-900">Create your account</h1>
        <p className="mt-2 text-gray-600">
          Get started with TaskManager for free
        </p>
      </div>

      <form onSubmit={handleSubmit} className="space-y-4">
        <div className="grid grid-cols-2 gap-4">
          <div className="space-y-2">
            <Label htmlFor="firstName">First name</Label>
            <div className="relative">
              <User className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
              <Input
                id="firstName"
                name="firstName"
                type="text"
                value={formData.firstName}
                onChange={handleChange}
                placeholder="John"
                className="pl-10"
                required
                disabled={isLoading}
                autoComplete="given-name"
              />
            </div>
          </div>
          <div className="space-y-2">
            <Label htmlFor="lastName">Last name</Label>
            <Input
              id="lastName"
              name="lastName"
              type="text"
              value={formData.lastName}
              onChange={handleChange}
              placeholder="Doe"
              required
              disabled={isLoading}
              autoComplete="family-name"
            />
          </div>
        </div>

        <div className="space-y-2">
          <Label htmlFor="email">Email address</Label>
          <div className="relative">
            <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
            <Input
              id="email"
              name="email"
              type="email"
              value={formData.email}
              onChange={handleChange}
              placeholder="john@example.com"
              className="pl-10"
              required
              disabled={isLoading}
              autoComplete="email"
            />
          </div>
        </div>

        <div className="space-y-2">
          <Label htmlFor="password">Password</Label>
          <div className="relative">
            <Lock className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
            <Input
              id="password"
              name="password"
              type={showPassword ? 'text' : 'password'}
              value={formData.password}
              onChange={handleChange}
              placeholder="Create a strong password"
              className="pl-10 pr-10"
              required
              minLength={6}
              disabled={isLoading}
              autoComplete="new-password"
            />
            <button
              type="button"
              onClick={() => setShowPassword(!showPassword)}
              className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
              disabled={isLoading}
            >
              {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
            </button>
          </div>
          {formData.password && formData.password.length < 6 && (
            <p className="text-sm text-red-600">Password must be at least 6 characters</p>
          )}
        </div>

        <div className="space-y-2">
          <Label htmlFor="confirmPassword">Confirm password</Label>
          <div className="relative">
            <Lock className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
            <Input
              id="confirmPassword"
              name="confirmPassword"
              type={showConfirmPassword ? 'text' : 'password'}
              value={formData.confirmPassword}
              onChange={handleChange}
              placeholder="Confirm your password"
              className={`pl-10 pr-10 ${!passwordsMatch ? 'border-red-500' : ''}`}
              required
              disabled={isLoading}
              autoComplete="new-password"
            />
            <button
              type="button"
              onClick={() => setShowConfirmPassword(!showConfirmPassword)}
              className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
              disabled={isLoading}
            >
              {showConfirmPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
            </button>
          </div>
          {!passwordsMatch && formData.confirmPassword && (
            <p className="text-sm text-red-600">Passwords do not match</p>
          )}
        </div>

        <div className="flex items-start space-x-2">
          <Checkbox
            id="terms"
            checked={acceptTerms}
            onCheckedChange={setAcceptTerms}
            disabled={isLoading}
            className="mt-1"
          />
          <Label htmlFor="terms" className="text-sm text-gray-600 leading-tight">
            I agree to the{' '}
            <Link href="/terms" className="text-blue-600 hover:text-blue-500">
              Terms of Service
            </Link>{' '}
            and{' '}
            <Link href="/privacy" className="text-blue-600 hover:text-blue-500">
              Privacy Policy
            </Link>
          </Label>
        </div>

        <Button
          type="submit"
          className="w-full"
          disabled={!isFormValid || isLoading}
        >
          {isLoading ? (
            <div className="flex items-center space-x-2">
              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white" />
              <span>Creating account...</span>
            </div>
          ) : (
            <div className="flex items-center space-x-2">
              <span>Create account</span>
              <ArrowRight className="h-4 w-4" />
            </div>
          )}
        </Button>
      </form>

      <div className="relative">
        <div className="absolute inset-0 flex items-center">
          <Separator className="w-full" />
        </div>
        <div className="relative flex justify-center text-xs uppercase">
          <span className="bg-white px-2 text-gray-500">Already have an account?</span>
        </div>
      </div>

      <div className="text-center">
        <Link href="/login">
          <Button variant="outline" className="w-full">
            Sign in instead
          </Button>
        </Link>
      </div>
    </div>
  )
}
```

### 7. Password Reset Flow

#### Create `app/(auth)/forgot-password/page.tsx`:
```typescript
'use client'

import { useState } from 'react'
import { useAuth } from '@/hooks/useAuth'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Separator } from '@/components/ui/separator'
import Link from 'next/link'
import { Mail, ArrowLeft, ArrowRight } from 'lucide-react'

export default function ForgotPasswordPage() {
  const [email, setEmail] = useState('')
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [emailSent, setEmailSent] = useState(false)
  
  const { resetPassword, loading } = useAuth()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (isSubmitting || loading) return

    try {
      setIsSubmitting(true)
      await resetPassword(email)
      setEmailSent(true)
    } catch (error) {
      console.error('Password reset failed:', error)
    } finally {
      setIsSubmitting(false)
    }
  }

  const isFormValid = email.length > 0
  const isLoading = loading || isSubmitting

  if (emailSent) {
    return (
      <div className="space-y-6 text-center">
        <div className="mx-auto w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
          <Mail className="w-6 h-6 text-green-600" />
        </div>
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Check your email</h1>
          <p className="mt-2 text-gray-600">
            We've sent a password reset link to <strong>{email}</strong>
          </p>
        </div>
        <div className="space-y-4">
          <p className="text-sm text-gray-500">
            Didn't receive the email? Check your spam folder or try again with a different email address.
          </p>
          <div className="flex flex-col space-y-2">
            <Button
              onClick={() => {
                setEmailSent(false)
                setEmail('')
              }}
              variant="outline"
              className="w-full"
            >
              Try another email
            </Button>
            <Link href="/login">
              <Button variant="ghost" className="w-full">
                <ArrowLeft className="w-4 h-4 mr-2" />
                Back to sign in
              </Button>
            </Link>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <div className="text-center">
        <h1 className="text-2xl font-bold text-gray-900">Forgot your password?</h1>
        <p className="mt-2 text-gray-600">
          Enter your email address and we'll send you a link to reset your password.
        </p>
      </div>

      <form onSubmit={handleSubmit} className="space-y-4">
        <div className="space-y-2">
          <Label htmlFor="email">Email address</Label>
          <div className="relative">
            <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
            <Input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder="Enter your email"
              className="pl-10"
              required
              disabled={isLoading}
              autoComplete="email"
              autoFocus
            />
          </div>
        </div>

        <Button
          type="submit"
          className="w-full"
          disabled={!isFormValid || isLoading}
        >
          {isLoading ? (
            <div className="flex items-center space-x-2">
              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white" />
              <span>Sending reset link...</span>
            </div>
          ) : (
            <div className="flex items-center space-x-2">
              <span>Send reset link</span>
              <ArrowRight className="h-4 w-4" />
            </div>
          )}
        </Button>
      </form>

      <div className="relative">
        <div className="absolute inset-0 flex items-center">
          <Separator className="w-full" />
        </div>
        <div className="relative flex justify-center text-xs uppercase">
          <span className="bg-white px-2 text-gray-500">Remember your password?</span>
        </div>
      </div>

      <div className="text-center">
        <Link href="/login">
          <Button variant="outline" className="w-full">
            <ArrowLeft className="w-4 h-4 mr-2" />
            Back to sign in
          </Button>
        </Link>
      </div>
    </div>
  )
}
```

### 8. Auth Callback Route

#### Create `app/auth/callback/route.ts`:
```typescript
import { createClient } from '@/lib/supabase/server'
import { NextRequest, NextResponse } from 'next/server'

export async function GET(request: NextRequest) {
  const { searchParams, origin } = new URL(request.url)
  const code = searchParams.get('code')
  const next = searchParams.get('next') ?? '/dashboard'

  if (code) {
    try {
      const supabase = await createClient()
      const { error } = await supabase.auth.exchangeCodeForSession(code)
      
      if (!error) {
        const forwardedHost = request.headers.get('x-forwarded-host') // original origin before load balancer
        const isLocalEnv = process.env.NODE_ENV === 'development'
        
        if (isLocalEnv) {
          // In development, redirect to localhost
          return NextResponse.redirect(`${origin}${next}`)
        } else if (forwardedHost) {
          // In production, redirect to the forwarded host
          return NextResponse.redirect(`https://${forwardedHost}${next}`)
        } else {
          // Fallback to the current origin
          return NextResponse.redirect(`${origin}${next}`)
        }
      }
    } catch (error) {
      console.error('Auth callback error:', error)
    }
  }

  // Return the user to an error page with instructions
  return NextResponse.redirect(`${origin}/auth/auth-code-error`)
}
```

### 9. Protected Route HOC

#### Create `components/auth/ProtectedRoute.tsx`:
```typescript
'use client'

import { useAuth } from '@/hooks/useAuth'
import { useRouter } from 'next/navigation'
import { useEffect } from 'react'
import { Skeleton } from '@/components/ui/skeleton'

interface ProtectedRouteProps {
  children: React.ReactNode
  redirectTo?: string
  fallback?: React.ReactNode
}

export function ProtectedRoute({ 
  children, 
  redirectTo = '/login',
  fallback 
}: ProtectedRouteProps) {
  const { user, loading, initialized } = useAuth()
  const router = useRouter()

  useEffect(() => {
    if (initialized && !loading && !user) {
      router.push(redirectTo)
    }
  }, [user, loading, initialized, router, redirectTo])

  // Show loading state while checking auth
  if (!initialized || loading) {
    return fallback || <AuthLoadingSkeleton />
  }

  // Don't render children if user is not authenticated
  if (!user) {
    return fallback || <AuthLoadingSkeleton />
  }

  return <>{children}</>
}

function AuthLoadingSkeleton() {
  return (
    <div className="min-h-screen bg-gray-50">
      <div className="flex h-16 items-center border-b bg-white px-4">
        <Skeleton className="h-8 w-32" />
        <div className="ml-auto flex items-center space-x-4">
          <Skeleton className="h-8 w-8 rounded-full" />
        </div>
      </div>
      <div className="container mx-auto p-6">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="md:col-span-2 space-y-4">
            <Skeleton className="h-8 w-48" />
            <div className="space-y-3">
              {[...Array(5)].map((_, i) => (
                <Skeleton key={i} className="h-16 w-full" />
              ))}
            </div>
          </div>
          <div className="space-y-4">
            <Skeleton className="h-8 w-32" />
            <Skeleton className="h-32 w-full" />
          </div>
        </div>
      </div>
    </div>
  )
}
```

### 10. App Layout with Auth Protection

#### Update `app/(app)/layout.tsx`:
```typescript
import { ProtectedRoute } from '@/components/auth/ProtectedRoute'
import { Header } from '@/components/layout/Header'
import { Sidebar } from '@/components/layout/Sidebar'

export default function AppLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <ProtectedRoute>
      <div className="flex h-screen bg-gray-50">
        <Sidebar />
        <div className="flex-1 flex flex-col overflow-hidden">
          <Header />
          <main className="flex-1 overflow-auto">
            {children}
          </main>
        </div>
      </div>
    </ProtectedRoute>
  )
}
```

### 11. Root Layout with Auth Provider

#### Update `app/layout.tsx`:
```typescript
import type { Metadata } from "next"
import { Inter } from "next/font/google"
import "./globals.css"
import { QueryProvider } from "@/components/providers/QueryProvider"
import { AuthProvider } from "@/components/providers/AuthProvider"
import { Toaster } from "@/components/ui/sonner"

const inter = Inter({ subsets: ["latin"] })

export const metadata: Metadata = {
  title: "TaskManager - Smart Personal Productivity",
  description: "A minimalist task manager with smart prioritization and focus modes",
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <QueryProvider>
          <AuthProvider>
            {children}
            <Toaster 
              position="top-right"
              expand={true}
              richColors
              closeButton
            />
          </AuthProvider>
        </QueryProvider>
      </body>
    </html>
  )
}
```

### 12. User Menu Component

#### Create `components/layout/UserMenu.tsx`:
```typescript
'use client'

import { useAuth } from '@/hooks/useAuth'
import { Button } from '@/components/ui/button'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import { User, Settings, LogOut, HelpCircle } from 'lucide-react'
import Link from 'next/link'

export function UserMenu() {
  const { user, signOut, loading } = useAuth()

  const handleSignOut = async () => {
    try {
      await signOut()
    } catch (error) {
      console.error('Sign out error:', error)
    }
  }

  const userInitials = user?.user_metadata?.full_name
    ?.split(' ')
    .map((n: string) => n[0])
    .join('')
    .toUpperCase() || user?.email?.[0]?.toUpperCase() || '?'

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" className="relative h-8 w-8 rounded-full">
          <Avatar className="h-8 w-8">
            <AvatarImage 
              src={user?.user_metadata?.avatar_url} 
              alt={user?.user_metadata?.full_name || user?.email} 
            />
            <AvatarFallback>{userInitials}</AvatarFallback>
          </Avatar>
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent className="w-56" align="end" forceMount>
        <DropdownMenuLabel className="font-normal">
          <div className="flex flex-col space-y-1">
            <p className="text-sm font-medium leading-none">
              {user?.user_metadata?.full_name || 'User'}
            </p>
            <p className="text-xs leading-none text-muted-foreground">
              {user?.email}
            </p>
          </div>
        </DropdownMenuLabel>
        <DropdownMenuSeparator />
        <DropdownMenuItem asChild>
          <Link href="/profile">
            <User className="mr-2 h-4 w-4" />
            <span>Profile</span>
          </Link>
        </DropdownMenuItem>
        <DropdownMenuItem asChild>
          <Link href="/settings">
            <Settings className="mr-2 h-4 w-4" />
            <span>Settings</span>
          </Link>
        </DropdownMenuItem>
        <DropdownMenuItem asChild>
          <Link href="/help">
            <HelpCircle className="mr-2 h-4 w-4" />
            <span>Help</span>
          </Link>
        </DropdownMenuItem>
        <DropdownMenuSeparator />
        <DropdownMenuItem 
          onClick={handleSignOut}
          disabled={loading}
        >
          <LogOut className="mr-2 h-4 w-4" />
          <span>Log out</span>
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  )
}
```

## Acceptance Criteria
- [ ] Sign-up page with email/password and user metadata
- [ ] Login page with show/hide password and form validation
- [ ] Forgot password flow with email confirmation
- [ ] Protected routes that redirect unauthenticated users
- [ ] User session persisted across refreshes with Zustand
- [ ] Logout functionality clears session and redirects
- [ ] Loading states during all auth operations
- [ ] User menu with profile access and sign out
- [ ] Auth callback route handling email confirmations
- [ ] Error handling with toast notifications
- [ ] Responsive auth layouts with branding
- [ ] Form validation and accessibility features
- [ ] Auto-creation of user preferences on signup
- [ ] Proper TypeScript types throughout

## Technical Details
- Custom auth provider with Supabase Auth
- Zustand store for auth state persistence
- Protected route HOC with loading states
- Comprehensive error handling and user feedback
- Responsive design with mobile-first approach
- Accessibility features (proper labels, ARIA attributes)
- Form validation with real-time feedback
- Auto-redirect logic based on auth state

## Dependencies
- [ ] Task 002 completed (Database schema with users)
- [ ] Supabase Auth configured with email provider
- [ ] shadcn/ui components installed

## Effort Estimate
- Size: M
- Hours: 8
- Parallel: false

## Definition of Done
- [ ] All authentication flows working end-to-end
- [ ] Protected routes tested and working
- [ ] Session persistence verified across refreshes
- [ ] Error handling implemented with user-friendly messages
- [ ] Loading states implemented for all auth operations
- [ ] Responsive design tested on mobile and desktop
- [ ] Form validation working correctly
- [ ] User preferences created automatically on signup
- [ ] Auth state synchronized across components
- [ ] No TypeScript errors or warnings
- [ ] Auth documentation added to README
